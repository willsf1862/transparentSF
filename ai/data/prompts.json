{
    "monthly_report": {
        "prioritize_deltas": {
            "system": "You are a data journalist helping create a monthly newsletter.",
            "prompt": "Given the following list of metrics with significant changes, identify EXACTLY {max_items} most important items to highlight in a monthly newsletter.\n\nConsider these factors when prioritizing:\nIMPORTANT: DO NOT select Jail bookings if the data is a month behind.\n1. Magnitude of the change (both absolute and percentage, higher is better). Avoid prioritizing very small magnitudes and high percentages, like a historic avg of 1 and a current of 3 is a 300% delta but 1 is tiny, so don't choose that unless its something very important, like homicides, for example.)\n2. The public importance of the metric (e.g., crime most important, then public safety, then housing, then the rest)\n3. Something interesting or newsworthy about the change.\n\nAdditionally, review the year-to-date metrics and notes provided below to determine if each change:\n- Represents a counter-trend (reversing previous patterns), if so choose it only if it is outside of it's normal range. In other words don't alarm people about a recent uptick in crime if its still far lower than it has been in the past and is well within its normal range.\n- Continues a broader trend already in progress\n- Represents a new development that requires special attention\n\nRECENT CHANGES:\n{changes_text}\n\nYEAR-TO-DATE METRICS AND NOTES:\n{notes_text_short}\n\nReturn your response as a JSON object with a property named \"items\" that contains an array of EXACTLY {max_items} objects with the following structure:\n```json\n{{\n  \"items\": [\n    {{\n      \"index\": 1,\n      \"metric\": \"Metric Name\",\n      \"metric_id\": \"Metric ID\",\n      \"group\": \"Group Value\",\n      \"priority\": 1,\n      \"explanation\": \"Detailed explanation of why this change is significant including wether its on trend or counter trend and what is interesting about it.\"\n    }},\n    {{\n      \"index\": 2,\n      ...\n    }},\n    ...more items to make exactly {max_items} total\n  ]\n}}\n```\n\nVERY IMPORTANT REQUIREMENTS:\n1. The \"items\" array MUST contain EXACTLY {max_items} objects, no more and no less.\n2. The \"index\" field MUST match the index number from the list of metrics above. This is essential for accurate processing.\n3. The array must be sorted by priority (1 being highest).\n4. Each object must include the exact metric name from the list above.\n5. The response must be valid JSON that can be parsed directly.\n6. Do not include any commentary or explanation outside the JSON structure.\n\nYou MUST select {max_items} different metrics. This is a hard requirement."
        },
        "generate_report": {
            "system": "You are a professional data scientist and newsletter writer for a transparent SF, a San Francisco  organization edicated to bringing data and accountability into the public discussion.",
            "prompt": "You are tasked with creating a comprehensive, citizen-focused monthly newsletter for San Francisco's {district_name} for {current_month}.\n\nDISTRICT INFORMATION:\n- District: {district_name}\n- District Official: {official_name} ({official_role})\n\nYour audience consists of intelligent, data-curious San Franciscans who want factual clarity without ideological spin. Make it punchy, compelling, and smart\u2014using a tone that's factual yet conversational, concise yet engaging. Headlines should snap attention instantly.\n\nTake the report text and combine and enhance it to be smooth and clear. \n\nFormatting and HTML Instructions:\n\nUse the provided HTML structure with Bootstrap styling for responsive design on all devices. Keep content crisp, structured, and visually appealing.\n\nNow, follow this HTML template precisely\u2014deliver only the complete HTML newsletter without additional markdown or code blocks.  \n\n\"<!DOCTYPE html><html lang=\\\\\\\"en\\\\\\\"><head><meta charset=\\\\\\\"UTF-8\\\\\\\" /><meta name=\\\\\\\"viewport\\\\\\\" content=\\\\\\\"width=device-width, initial-scale=1\\\\\\\" /><title>{district_name} Monthly Newsletter \u2013 {current_month}</title><link href=\\\\\\\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css\\\\\\\" rel=\\\\\\\"stylesheet\\\\\\\"><style>body{{font-family:'IBM Plex Sans', Arial, sans-serif;color:#222;background-color:#fff;padding:2rem;max-width:1000px;margin:auto;}}h1,h2,h3{{font-family:'Inter', Arial, sans-serif;color:#000;}}.section{{margin-bottom:2.5rem;}}.takeaways ul{{list-style:none;padding-left:0;}}.takeaways li::before{{content:\\\\\\\"\u2022 \\\\\\\",color:#000;font-weight:bold;margin-right:0.5rem;}}.chart{{margin:1.5rem 0;text-align:center;}}.footer{{font-size:0.85rem;color:#666;border-top:1px solid #ccc;padding-top:1rem;margin-top:3rem;}}</style></head><body><header class=\\\\\\\"mb-4\\\\\\\"><h1>{current_month}: [INSERT HEADLINE]</h1></header><section class=\\\\\\\"section takeaways\\\\\\\"><h2>Key Takeaway</h2><ul><li>\ud83d\udea8 <strong>Crime:</strong> [INSERT SUMMARY]</li></ul></section><section class=\\\\\\\"section\\\\\\\"><h2>The Story in Data</h2>[INSERT REPORT TEXT WITH INLINE CHARTS]</section><footer class=\\\\\\\"footer\\\\\\\"><p>Generated on  [CURRENT DATE],by TransparentSF</p></footer></body></html>\"\n\nEnsure that all referenced hyperlinks in the report text remain in if the text they are referencing remains in the newsletter.  \n\nContent Structure: Bring the data to life within the provided HTML template by following this snappy, reader-friendly format:\n\nWhen data drops significantly, consider vivid verbs like:\nPlummets, Spirals, Nosedives, Tanks, Craters, Tumbles, Collapses, Sinks, Slumps, Dives, Freefalls, Skids, Drops, Falls, Slides.\nWhen it jumps significantly, go bold with verbs such as:\nExplodes, Rockets, Spikes, Zips, Soars, Balloons, Surges, Leaps, Jumps, Shoots, Catapults, Escalates, Erupts, Skyrockets, Bursts.\nKey Takeaways (At a Glance): Summarize each key metric in punchy list items, kicking off each with a fun emoji for visual flair. Clearly show the metric name, absolute change, percentage change in bold, and give readers a quick, conversational nugget to explain what happened.\n\nThe Story in Data (Dive Deeper):\n\nEach main topic\u2014like Housing, Crime, Transit\u2014gets its own lively section using the topic-block structure.\n\n1. Lead off your headings with an eye-catching emoji\n2. Follow with a subheading that hooks the reader\u2014witty, clever, intriguing\n3. Write 2-3 paragraphs of compelling narrative in a conversational, accessible tone\n4. IMPORTANT: Keep all chart references exactly where they appear in the report text. Do not move them to the template's chart sections.\nVERY IMPORTANT: Each chart must remain exactly where it appears in the report text. Do not separate charts from their topics or move them to the template's chart sections. Do not remove links.\n\nSimply return the complete HTML newsletter\u2014no extra markdown formatting or code blocks needed.\n\nHere's the text you'll build your newsletter around:{report_items_text}\\n"
        },
        "proofread": {
            "system": "You are a professional editor and proofreader for a civic transparency organization with expertise in data-driven content for the public.",
            "prompt": "You are a professional editor tasked with thoroughly proofreading and significantly improving a citizen-focused newsletter for San Francisco. I need comprehensive, detailed feedback and polished revisions to elevate this content to professional standards.\n\nBRAND GUIDELINES:\n- Voice: Intelligent but accessible, civic-minded (not partisan)\n- Tone: Factual, clear, non-righteous, with occasional dry wit\n- Focus: Impact over ideology, precision over polish\n- Approach: Assume no ill intention from public officials, drive accountability while being fair and data-driven\n- Style: Clean and clear in design and tone, calm and credible\n\nPlease review the following newsletter and make these improvements:\n\n1. Thoroughly edit for grammatical, spelling, and syntax issues - provide specific examples of problems found and how you fixed them\n2. Ensure consistent formatting and style. Make sure that charts that are associated with a particular metric are grouped within that metric's section. Don't remove charts.\n3. Ensure that numbers are appropriately rounded (integers for counts, one decimal for percentages) to avoid false precision on averages and percent changes.\n4. Handle small changes carefully: Don't emphasize percents when the absolute value of a change is less than 5. For example, if drug incidents increase from 1 to 2, don't headline with \"Drug Incidents double in district 3\" - instead use \"District 2 Drug Incidents Trending Upward\". Always include absolute numbers, but be judicious with percentage emphasis for small-number changes.\n5. Refine tone to align precisely with brand guidelines - intelligent but accessible, civic-minded, and focused on impact rather than sensationalism.\n6. Enhance readability and flow - reorganize content if necessary to build a more cohesive narrative that feels like direct communication to citizens rather than a formal report.\n7. Headlines: Develop three strong, alternative headlines that would ensure email deliverability and high open rates. Consider the original headline as inspiration but craft these as distinctive options.\n\nFor crafting the three headlines, apply these specific techniques:\nYour headlines need energy and precision. Ditch dull and passive language. Write active, vivid sentences.\nDo NOT write this: \"April 2025: Drug Crime Incidents Rise in San Francisco.\"\nWrite like this: \"Drug Crime Reports Rise Sharply in San Francisco in April.\"\nOr Even Better, Add add some mystery, like, \u201cYou Won\u2019t Believe What Happened in District 2\u2019s Crime Numbers this month.\u201d \n\n\u2022 Lead with Core Value - Start with what readers will gain (insight, benefit, or surprising takeaway)\n\u2022 Use Specificity - Include concrete language, data points, or outcomes instead of vague statements\n\u2022 Apply Active Voice - Use strong verbs and direct constructions (\"SF Cuts Crime by 20%\" vs \"There was a reduction\")\n\u2022 Optimize Length - Aim for 7-12 words that balance scannability with substance\n\u2022 Maintain Brand Voice - Reflect the newsletter's dry, witty, civic and direct tone\n\u2022 Create Curiosity - Invite intrigue without resorting to clickbait techniques\n\u2022 Enhance Skimmability - Front-load important terms and use simple syntax\n\u2022 Consider Emotional Resonance - Select words that connect with readers through appropriate tone (urgency, hope, etc.)\n\nProvide a detailed analysis of the newsletter's structure, content organization, and narrative flow, with specific suggestions for improvement. For each section, identify both strengths to maintain and weaknesses to address.\n\nHere's the newsletter:\n\n{newsletter_text}\n\nIMPORTANT: You must escape all double quotes (\") and backslashes (\\) in the HTML content.\nYou must return only a valid JSON object, with no extra text before or after.\nDo not truncate the JSON object. If the content is too long, summarize instead of truncating.\n\nPlease provide A Json object with a revised version of the newsletter HTML under the key \"newsletter\", the headlines in an array called \"headlines\" and your comprehensive feedback (at least 500 words) on what was edited and why in a key called \"proofread_feedback\".\n\nKeep all HTML tags intact and ensure the formatting remains clean and consistent while making substantive improvements to content, flow, and clarity."
        },
        "context_enrichment": {
            "system": "You are a an information retrieval expert and analyst.",
            "prompt": "I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. \n\nIf the extract is focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. \n\nNEWSLETTER EXTRACT:\n{text_content}\n\nPlease provide your results in 2 sections: \n1. Recent news related to this topic, and especially \n2. Direct quotes from elected officials.  \n\nEach section should be a few sentences max. Keep your answer to at most 1500 tokens and provide only what people will really care about. "
        },
        "generate_report_text": {
            "system": "You are a helpful assistant for assembling newsletter stories.",
            "prompt": "Review the following content and assemble it into a 3-5 paragraph news story.  \n\nVoice & Style Guide:\n\nPrioritize clarity and readability, always with a dash of dry wit\u2014clever without sounding righteous, factual without sounding clinical.\n\nAvoid passive phrasing like:\n \"In April 2025, San Francisco saw a notable increase in drug crime incidents, with a citywide rise of 12% from the previous month, reflecting a broader year-to-date increase of 44% over last year.\"\n\nInstead, write actively and directly:\n \"April marked another uptick for San Francisco's drug crisis, as crime surged 12% from March\u2014pushing drug-related offenses up 44% compared to last year.\"\n\nYour Goal: Transform the provided data into a gripping narrative that ties various metrics into a clear, cohesive story. \n\nStick strictly to what happened\u2014never speculate why. Remember, increases in police reports could mean better enforcement or rising crime. Decreases might be fewer incidents or lax enforcement. Because we don't definitively know reasons, keep it factual and dry\u2014skip adjectives like \"concerning\" or \"unexpected.\" Headlines should specify the month clearly (\"March Drug Incidents Up,\" etc.).\n\nInstructions for Building the Narrative:\nFind the threads linking different data points. Does crime data reflect similar patterns to housing or transit changes? Are citywide trends echoed or contrasted in a district? Highlight interesting anomalies\u2014especially positive ones.\n\nWhen mentioning public officials, use their district or role as context, e.g., \"Stephen Sherrill's District 2 saw a 12% drop in theft.\" When possible, emphasize positive trends associated with officials. Positive crime anomalies are especially good.\n\nYou'll receive supplemental citations and references to them from web searches summarized by AI. \n\nANY TIME you use this info in your narrative, and always include an HTML hyperlink to the source.  Everything in the context is linked to a citation of the same number which should be referenced.  Link the text that best describes the content in text, with the domain listed in parentheses. All content of any sort including quotes from officials or specific claims MUST link directly to the supporting source.  Like this: \n\n'168 unit Casa Adente, at 1515 Van Ness <a href='https://whatnow.com/san-francisco/real-estate/168-unit-affordable-housing-development-breaks-ground-in-san-franciscos-mission-district/'>broke ground in the mission (whatnow.com)</a> last month.'\n\nIMPORTANT - Chart Placement Instructions:\n1. Each chart reference (e.g., [CHART:time_series:13:0:month] or [CHART:anomaly:323891]) should be placed inline with the text where it will have the most explanatory effect.\n2. For anomaly charts, read the caption to understand what the chart shows and place it near the text that discusses that specific trend or change.\n3. For time series charts, place them near the text that discusses the overall trend or pattern they illustrate.\n4. Do not group all charts together at the end - integrate them naturally into the narrative where they best support the story.\n5. When you place a chart reference, make sure the surrounding text provides context for what the chart will show.\n\nRationale: {rationale}\nExplanation: {explanation}\nTrend Analysis: {trend_analysis}\nFollow-up Questions: {follow_up}\nCharts: {charts}\nCitations: {citations}\nAdditional Context: {perplexity_context}"
        }
    }
}
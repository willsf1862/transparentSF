<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Transparent SF Agent Chat</title>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
        />
        <style>
            /* Reset and base styles */
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body,
            html {
                height: 100%;
                font-family: Arial, sans-serif;
                background-color: #f9f9f9;
                /* Base font size */
                font-size: 12px;
            }

            /* Layout */
            .main {
                display: flex;
                height: 100vh;
                width: 100%;
            }

            .chat {
                width: 50%;
                height: 100vh;
                display: flex;
                flex-direction: column;
                border-right: 1px solid #ccc;
                /* Ensure padding for better readability */
                padding: 20px;
            }

            .chat h1 {
                /* Header font size */
                font-size: 2em;
                margin-bottom: 20px;
                text-align: center;
                position: relative; /* Add this to position the new chat button */
            }

            #chat-container {
                display: flex;
                flex-direction: column;
                flex: 1;
                height: calc(100vh - 70px); /* Adjusted for increased padding */
                overflow: hidden;
                padding: 10px;
            }

            #response-area {
                flex-grow: 1;
                overflow-y: auto;
                height: calc(100% - 80px); /* Adjusted for increased padding */
                border: 1px solid #eee;
                padding: 15px; /* Increased padding */
                background-color: #ffffff;
                /* Increase font size for messages */
                font-size: 1.1em;
                /* Prevent horizontal scroll */
                overflow-x: hidden;
            }

            /* Message styling */
            .message {
                padding: 15px 20px; /* Increased padding */
                margin: 8px 0; /* Increased margin */
                border-radius: 20px; /* More rounded corners */
                max-width: 100%;
                word-wrap: break-word;
                display: inline-block;
                position: relative;
                clear: both;
                /* Increase font size */
                font-size: 1.1em;
            }

            .user-message {
                background-color: #e6f7ff;
                align-self: flex-end;
                float: right;
            }
            .ai-message {
                background-color: #f0f0f0;
                align-self: flex-start;
                float: left;
            }

            .sender {
                font-weight: bold;
                display: inline;
                font-size: 1em;
            }

            /* Tool call styling */
            .tool-call {
                background-color: #fffae6;
                color: #6b5b95;
                font-style: italic;
                border-left: 4px solid #6b5b95;
                padding: 8px; /* Increased padding */
                margin: 12px 0; /* Increased margin */
                font-size: 1em; /* Increased font size */
            }

            /* Input area */
            #input-container {
                display: flex;
                margin-top: 15px; /* Increased margin */
            }

            #userInput {
                flex-grow: 1;
                padding: 12px; /* Increased padding */
                border: 1px solid #ccc;
                border-radius: 5px;
                /* Ensure font size is at least 16px to prevent zoom */
                font-size: 16px;
            }

            #submit-button {
                margin-left: 12px; /* Increased margin */
                padding: 12px 24px; /* Increased padding */
                border: none;
                background-color: #007bff;
                color: #ffffff;
                border-radius: 5px;
                cursor: pointer;
                /* Ensure button has consistent font size */
                font-size: 16px;
                flex-shrink: 0; /* Prevent button from shrinking */
            }

            /* Responsive Images and Charts */
            #response-area img,
        #response-area canvas, /* For charts rendered as canvas */
        #response-area svg {
                /* For SVG charts */
                max-width: 100%;
                height: auto;
                display: block;
                margin: 10px 0; /* Optional: Add some margin for spacing */
            }

            /* List Styling */
            #response-area ul,
            #response-area ol {
                margin-left: 20px; /* Proper indentation */
                padding-left: 10px; /* Additional padding to align bullets/numbers */
            }

            #response-area li {
                margin-bottom: 5px; /* Spacing between list items */
            }
            #response-area p {
                margin-top: 1em; /* Add space after paragraphs */
            }

            #response-area p:last-child {
                margin-bottom: 0; /* Remove margin from last paragraph to avoid extra space */
            }
            /* Mobile and Portrait styles */
            @media (max-width: 767px), (orientation: portrait) {
                .divider,
                .canvas-container {
                    display: none;
                }
                #response-area p {
                    margin-top: 0.8em; /* Slightly less spacing on mobile */
                }
                .chat {
                    width: 100%;
                    border-right: none;
                    background-color: #1a1a1a;
                    padding: 0;
                    display: flex;  /* Add flex display */
                    flex-direction: column;  /* Stack children vertically */
                }

                .chat h1 {
                    font-size: 1.2em;  /* Reduced from 1.4em */
                    color: #ffffff;
                    margin: 10px;  /* Reduced margin */
                    text-align: center;
                    position: sticky;  /* Make header sticky */
                    top: 0;  /* Stick to top */
                    background-color: #1a1a1a;  /* Match background */
                    z-index: 1001;  /* Ensure it stays above content */
                    padding: 5px 0;  /* Add some padding */
                }

                body {
                    font-size: 16px;  /* Reduced from 18px */
                    background-color: #1a1a1a;
                    color: #ffffff;
                }

                #chat-container {
                    padding: 1px; /* Maintain minimal padding */
                }

                #response-area {
                    background-color: #2d2d2d;
                    border-color: #444;
                    margin-bottom: 80px; /* Increased margin to accommodate fixed input */
                    font-size: 1em; /* Slightly decreased from 1.2em to 1em */
                    padding: 10px; /* Reduced padding to save space */
                    line-height: 1.7; /* Added line height for better readability */
                }

                /* Adjust message sizes */
                .message {
                    font-size: 0.95em;  /* Reduced from 1.1em */
                    padding: 12px 16px;  /* Increased padding for better readability */
                    margin: 10px 5px;  /* Added horizontal margin and increased vertical margin */
                    border-radius: 15px;  /* Slightly more rounded corners */
                    max-width: 85%;  /* Limit maximum width of messages */
                }

                .user-message {
                    background-color: #264653;
                    color: #ffffff;
                    margin-left: auto;  /* Push user messages to the right */
                    margin-right: 5px;  /* Add some space from the right edge */
                }
                .ai-message {
                    background-color: #2a3f4d;
                    color: #ffffff;
                    margin-right: auto;  /* Push AI messages to the left */
                    margin-left: 5px;  /* Add some space from the left edge */
                }

                #input-container {
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    padding: 15px; /* Maintained padding */
                    background-color: #2d2d2d;
                    z-index: 1000;
                    /* Adjust flex properties for better alignment */
                    display: flex;
                    align-items: center;
                }

                #submit-button {
                    background-color: #2a9d8f;
                    font-size: 16px;
                    padding: 12px 20px;
                    min-height: 44px;
                    flex-shrink: 0; /* Ensure button does not shrink */
                }

                #userInput {
                    font-size: 16px;
                    padding: 12px;
                    min-height: 44px;
                    border-radius: 8px;
                    background-color: #333;
                    color: #fff;
                    /* Ensure input takes available space without causing overflow */
                    margin-right: 10px;
                }

                /* Ensure the "Send" button is always visible and aligned */
                #input-container button {
                    white-space: nowrap;
                }

                /* Adjust tool-call font size on mobile */
                .tool-call {
                    font-size: 0.9em; /* Slightly reduced font size */
                    padding: 6px; /* Reduced padding */
                    margin: 10px 0; /* Reduced margin */
                }

                /* Adjust sender font size on mobile */
                .sender {
                    font-size: 0.9em; /* Reduced from 1em to 0.9em */
                }

                /* Responsive Images and Charts on Mobile */
                #response-area img,
                #response-area canvas,
                #response-area svg {
                    max-width: 100%;
                    height: auto;
                    display: block;
                    margin: 8px 0; /* Adjusted margin for mobile */
                    margin-bottom: 0.8em; /* Slightly less spacing on mobile */

                }

                /* List Styling on Mobile */
                #response-area ul,
                #response-area ol {
                    margin-left: 15px; /* Reduced indentation for mobile */
                    padding-left: 10px; /* Additional padding to align bullets/numbers */
                }

                #response-area li {
                    margin-bottom: 4px; /* Reduced spacing between list items */
                }
            }

            .canvas-container {
                flex: 1;  /* Add this to make it take remaining space */
                height: 100vh;
                display: flex;  /* Add this to ensure iframe fills container */
            }

            .canvas-container iframe {
                flex: 1;  /* Add this to make iframe fill container */
                width: 100%;
                height: 100%;
                border: none;
            }

            #loginForm {
                max-width: 300px;
                margin: 100px auto;
                padding: 20px;
                border: 1px solid #ccc;
                border-radius: 5px;
                text-align: center;
            }
            .input-group {
                margin: 10px 0;
            }
            .input-group input {
                width: 100%;
                padding: 8px;
                margin: 5px 0;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            .btn {
                padding: 8px 20px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .btn:hover {
                background-color: #0056b3;
            }
            #logout {
                position: absolute;
                top: 10px;
                right: 10px;
            }

            /* Add new overlay styles */
            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.9);
                z-index: 2000;
                overflow: auto;
            }

            .overlay-content {
                position: relative;
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
            }

            .overlay-header {
                padding: 15px;
                background-color: #2d2d2d;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .close-overlay {
                background: none;
                border: none;
                color: #ffffff;
                font-size: 24px;
                cursor: pointer;
                padding: 5px 15px;
            }

            .overlay iframe {
                flex: 1;
                width: 100%;
                border: none;
                background: #ffffff;
            }

            /* Add new chat button styles */
            #newChatButton {
                position: absolute;
                left: 20px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                font-size: 1.5em;
                cursor: pointer;
                padding: 5px 10px;
                color: #999;
            }

            /* Add blinking cursor animation */
            @keyframes blink {
                0% { opacity: 1; }
                50% { opacity: 0; }
                100% { opacity: 1; }
            }

            .typing-indicator {
                display: inline-block;
                width: 4px;
                height: 16px;
                background-color: #ffffff;
                margin-left: 4px;
                animation: blink 1s infinite;
            }
        </style>
    </head>
    <body>
        <div id="loginForm">
            <h2>Login Required</h2>
            <form onsubmit="return checkLogin(event)">
                <div class="input-group">
                    <input type="text" id="username" placeholder="Username" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Password" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
        </div>

        <div id="chatInterface" style="display: none;">
            <button id="logout" class="btn" onclick="logout()">Logout</button>
            <div class="main">
                <div class="chat">
                    <h1>
                        <button id="newChatButton" title="Start new chat">+</button>
                        Transparent SF Agent Chat
                    </h1>
                    <div id="chat-container">
                        <div id="response-area"></div>
                        <div id="input-container">
                            <input
                                type="text"
                                id="userInput"
                                placeholder="Type your message..."
                                autocomplete="off"
                            />
                            <button id="submit-button">Send</button>
                        </div>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="canvas-container">
                    <iframe
                        name="canvasTarget"
                        style="width: 100%; height: 100%; border: none"
                    ></iframe>
                </div>
            </div>
        </div>

        <!-- Add overlay markup -->
        <div id="mobileOverlay" class="overlay">
            <div class="overlay-content">
                <div class="overlay-header">
                    <button class="close-overlay" onclick="closeMobileOverlay()">Ã—</button>
                </div>
                <iframe id="overlayFrame" name="overlayFrame"></iframe>
            </div>
        </div>

        <!-- Include Marked.js library -->
        <script src="https://cdn.jsdelivr.net/npm/marked@4.2.12/marked.min.js"></script>
        <!-- Include DOMPurify library -->
        <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

        <script>
            // Corrected element references
            const responseArea = document.getElementById("response-area");
            const userInput = document.getElementById("userInput"); // Correct ID
            const submitBtn = document.getElementById("submit-button"); // Correct ID
            let currentAIMessage = null;

            function handleServerMessage(data) {
                console.log("Received message:", data);

                if (currentAIMessage == null) {
                    currentAIMessage = addMessage(
                        data.sender || "AI",
                        "ai-message",
                    );
                    currentAIMessage.contentSegments = []; // Initialize content segments array
                }

                if (data.type === "content" || data.type === "tool_call") {
                    if (data.type === "content") {
                        // Append to the last content segment if it's a string
                        if (
                            typeof currentAIMessage.contentSegments[
                                currentAIMessage.contentSegments.length - 1
                            ] === "string"
                        ) {
                            currentAIMessage.contentSegments[
                                currentAIMessage.contentSegments.length - 1
                            ] += data.content;
                        } else {
                            currentAIMessage.contentSegments.push(data.content);
                        }
                    } else if (data.type === "tool_call") {
                        // Add the tool call object as a segment
                        currentAIMessage.contentSegments.push({
                            type: "tool_call",
                            function_name: data.function_name,
                            arguments: data.arguments,
                        });
                    }

                    // Re-render the content segments
                    renderContentSegments(currentAIMessage);
                } else {
                    console.warn("Unknown message type:", data.type);
                }

                responseArea.scrollTop = responseArea.scrollHeight;
            }

            function renderContentSegments(message) {
                // Clear the content element
                message.contentElement.innerHTML = "";

                // Configure Marked.js
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    headerIds: false,
                    mangle: false,
                });

                // Process each segment
                for (let segment of message.contentSegments) {
                    if (typeof segment === "string") {
                        // It's a markdown content segment
                        try {
                            const htmlContent = marked.parse(segment);
                            const sanitizedContent =
                                DOMPurify.sanitize(htmlContent);
                            const tempDiv = document.createElement("div");
                            tempDiv.innerHTML = sanitizedContent;

                            // Modify links to open in the specified frame
                            modifyLinksToOpenInFrame(tempDiv, "canvasTarget");

                            // Append the content to the message content element
                            while (tempDiv.firstChild) {
                                message.contentElement.appendChild(
                                    tempDiv.firstChild,
                                );
                            }
                        } catch (error) {
                            console.warn("Markdown parsing error:", error);
                            // Optionally, handle parsing errors
                        }
                    } else if (segment.type === "tool_call") {
                        // It's a tool call segment
                        const toolCallElement = createToolCallElement(
                            segment.function_name,
                            segment.arguments,
                        );
                        message.contentElement.appendChild(toolCallElement);
                    }
                }
            }

            function createToolCallElement(functionName, args) {
                const toolCallContainer = document.createElement("div");
                toolCallContainer.className = "tool-call";

                const toolCallHeader = document.createElement("div");
                toolCallHeader.className = "tool-call-header";

                const toggleButton = document.createElement("button");
                toggleButton.textContent = "[+]";
                toggleButton.className = "toggle-button";
                // Style the toggle button for better visibility
                toggleButton.style.background = "none";
                toggleButton.style.border = "none";
                toggleButton.style.color = "#6b5b95";
                toggleButton.style.cursor = "pointer";
                toggleButton.style.fontSize = "1em";
                toggleButton.style.marginRight = "10px";

                toolCallHeader.appendChild(toggleButton);
                toolCallHeader.appendChild(
                    document.createTextNode(` Tool Call: ${functionName}`),
                );

                const argsContainer = document.createElement("div");
                argsContainer.className = "tool-call-args";
                argsContainer.textContent = `Arguments: ${JSON.stringify(args, null, 2)}`;
                argsContainer.style.marginLeft = "24px"; // Indent arguments for clarity

                toggleButton.addEventListener("click", () => {
                    if (argsContainer.style.display === "none") {
                        argsContainer.style.display = "block";
                        toggleButton.textContent = "[-]";
                    } else {
                        argsContainer.style.display = "none";
                        toggleButton.textContent = "[+]";
                    }
                });

                argsContainer.style.display = "none"; // Start collapsed
                toolCallContainer.appendChild(toolCallHeader);
                toolCallContainer.appendChild(argsContainer);

                return toolCallContainer;
            }

            async function sendMessage() {
                const query = userInput.value.trim();
                if (!query) return;

                // Add user's message to chat log
                const userMessage = addMessage("You", "user-message");
                const htmlContent = marked.parse(query);
                userMessage.contentElement.innerHTML =
                    DOMPurify.sanitize(htmlContent);

                // Reset currentAIMessage to null
                currentAIMessage = null;

                // Create initial AI message with typing indicator
                currentAIMessage = addMessage("AI", "ai-message");
                const typingIndicator = document.createElement("div");
                typingIndicator.className = "typing-indicator";
                currentAIMessage.contentElement.appendChild(typingIndicator);

                userInput.value = "";

                try {
                    const response = await fetch('/chat/api/chat', {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ query }),
                    });

                    // Remove typing indicator when we get the first response
                    currentAIMessage.contentElement.removeChild(typingIndicator);
                    currentAIMessage.contentSegments = [];

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    let buffer = "";
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        console.log("Received chunk:", chunk);
                        buffer += chunk;

                        // Process complete lines
                        let lines = buffer.split("\n");
                        buffer = lines.pop(); // Keep the last incomplete line in the buffer

                        for (const line of lines) {
                            if (line.trim()) {
                                try {
                                    const data = JSON.parse(line);
                                    handleServerMessage(data);
                                } catch (e) {
                                    console.error("Error parsing JSON:", e);
                                    console.error("Invalid JSON:", line);
                                }
                            }
                        }
                    }

                    // Process any remaining data in the buffer
                    if (buffer.trim()) {
                        try {
                            const data = JSON.parse(buffer);
                            handleServerMessage(data);
                        } catch (e) {
                            console.error("Error parsing JSON:", e);
                            console.error("Invalid JSON:", buffer);
                        }
                    }
                } catch (error) {
                    console.error("Error:", error);
                    addMessage(
                        "Error",
                        "error-message",
                    ).contentElement.textContent =
                        "An error occurred. Please try again.";
                }
            }
            function addMessage(sender, messageType) {
                const messageContainer = document.createElement("div");
                messageContainer.className = `message ${messageType}`;

                const senderElement = document.createElement("div");
                senderElement.className = "sender";
                senderElement.textContent = sender ? `${sender}:` : "";

                const contentElement = document.createElement("div");
                contentElement.className = "message-content";

                messageContainer.appendChild(senderElement);
                messageContainer.appendChild(contentElement);
                responseArea.appendChild(messageContainer);
                responseArea.scrollTop = responseArea.scrollHeight;

                return {
                    messageContainer,
                    contentElement,
                    contentSegments: [], // Initialize content segments array
                };
            }
            // JavaScript for draggable divider
            const divider = document.querySelector(".divider");
            const chat = document.querySelector(".chat");
            const canvas = document.querySelector(".canvas-container");
            let isDragging = false;
            let isMobile = window.innerWidth < 768;

            // Update resize handler on window resize
            window.addEventListener("resize", () => {
                isMobile = window.innerWidth < 768;
            });

            divider.addEventListener("mousedown", function (e) {
                isDragging = true;
                document.body.style.cursor = isMobile
                    ? "row-resize"
                    : "col-resize";
                e.preventDefault();
            });

            document.addEventListener("mousemove", function (e) {
                if (!isDragging) return;

                if (isMobile) {
                    // Vertical resizing for mobile
                    const main = document.querySelector(".main");
                    const mainRect = main.getBoundingClientRect();
                    let newChatHeight = e.clientY;

                    // Set minimum heights (20% of viewport height)
                    const minHeight = window.innerHeight * 0.2;
                    const maxHeight = window.innerHeight * 0.8;

                    if (newChatHeight < minHeight) newChatHeight = minHeight;
                    if (newChatHeight > maxHeight) newChatHeight = maxHeight;

                    chat.style.height = `${newChatHeight}px`;
                    canvas.style.height = `${window.innerHeight - newChatHeight - divider.offsetHeight}px`;
                } else {
                    // Horizontal resizing for desktop
                    const main = document.querySelector(".main");
                    const mainRect = main.getBoundingClientRect();
                    let newChatWidth = e.clientX;

                    const minWidth = 200;
                    const maxWidth = mainRect.width - 200;

                    if (newChatWidth < minWidth) newChatWidth = minWidth;
                    if (newChatWidth > maxWidth) newChatWidth = maxWidth;

                    chat.style.width = `${newChatWidth}px`;
                }
            });

            document.addEventListener("mouseup", function () {
                if (isDragging) {
                    isDragging = false;
                    document.body.style.cursor = "default";
                }
            });

            // Ensure JavaScript runs after DOM is loaded
            document.addEventListener("DOMContentLoaded", function () {
                const submitButton = document.getElementById("submit-button");
                const inputBox = document.getElementById("userInput");

                if (submitButton && inputBox) {
                    submitButton.addEventListener("click", sendMessage);
                    inputBox.addEventListener("keypress", function (e) {
                        if (e.key === "Enter") {
                            sendMessage();
                        }
                    });
                } else {
                    console.error("submit-button or input-box not found.");
                }
            });

            function modifyLinksToOpenInFrame(element, frameId) {
                const links = element.getElementsByTagName("a");
                for (let link of links) {
                    if (window.innerWidth <= 767) {
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            openMobileOverlay(this.href);
                        });
                    } else {
                        link.setAttribute("target", frameId);
                    }
                }
            }

            function openMobileOverlay(url) {
                const overlay = document.getElementById('mobileOverlay');
                const frame = document.getElementById('overlayFrame');
                frame.src = url;
                overlay.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }

            function closeMobileOverlay() {
                const overlay = document.getElementById('mobileOverlay');
                const frame = document.getElementById('overlayFrame');
                overlay.style.display = 'none';
                frame.src = '';
                document.body.style.overflow = 'auto';
            }

            // Update link handling when window is resized
            window.addEventListener('resize', function() {
                const responseArea = document.getElementById('response-area');
                const links = responseArea.getElementsByTagName('a');
                
                for (let link of links) {
                    if (window.innerWidth <= 767) {
                        link.removeAttribute('target');
                        // Ensure click handler is added
                        link.onclick = function(e) {
                            e.preventDefault();
                            openMobileOverlay(this.href);
                        };
                    } else {
                        link.setAttribute('target', 'canvasTarget');
                        link.onclick = null;
                    }
                }
            });

            // Check login status when page loads
            document.addEventListener('DOMContentLoaded', function() {
                checkLoginStatus();
            });

            function checkLoginStatus() {
                const isLoggedIn = sessionStorage.getItem('isLoggedIn');
                if (isLoggedIn) {
                    showChat();
                } else {
                    showLogin();
                }
            }

            function showChat() {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('chatInterface').style.display = 'block';
            }

            function showLogin() {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('chatInterface').style.display = 'none';
            }

            function checkLogin(event) {
                event.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                // Simple hash of the credentials (not secure but better than plaintext in source)
                const validUsername = btoa('demo');
                const validPassword = btoa('demo99');
                
                if (btoa(username) === validUsername && btoa(password) === validPassword) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    showChat();
                } else {
                    alert('Invalid credentials. Please try again.');
                    document.getElementById('password').value = '';
                }
                return false;
            }

            function logout() {
                sessionStorage.removeItem('isLoggedIn');
                showLogin();
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }

            // Prevent access to chat interface through console
            setInterval(checkLoginStatus, 1000);

            // Update the new chat button click handler
            document.getElementById('newChatButton').addEventListener('click', async function() {
                responseArea.innerHTML = ''; // Clear all messages
                currentAIMessage = null; // Reset current AI message
                
                // Call the server to reset the conversation
                try {
                    await fetch('/chat/api/reset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                } catch (error) {
                    console.error('Failed to reset conversation:', error);
                }
            });
        </script>
    </body>
</html>

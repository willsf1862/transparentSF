<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Metric Control</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .form-group {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .output-windows {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .output-window {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        .output-window h3 {
            margin-top: 0;
            color: #444;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .output-content {
            white-space: pre-wrap;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }
        .output-content.markdown {
            padding: 15px;
        }
        .output-content.markdown h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .output-content.markdown h2 {
            font-size: 20px;
            margin: 15px 0;
            color: #34495e;
        }
        .output-content.markdown h3 {
            font-size: 18px;
            margin: 12px 0;
            color: #2c3e50;
        }
        .output-content.markdown p {
            margin: 10px 0;
        }
        .output-content.markdown code {
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        .output-content.markdown pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .output-content.markdown table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        .output-content.markdown th,
        .output-content.markdown td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .output-content.markdown th {
            background-color: #f8f9fa;
        }
        .output-content.markdown tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .output-content.markdown blockquote {
            border-left: 4px solid #ddd;
            margin: 15px 0;
            padding-left: 15px;
            color: #666;
        }
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #007BFF;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Add styles for column selection */
        .column-selection {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .column-selection h3 {
            margin-top: 0;
            color: #444;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .column-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .column-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .column-item input[type="checkbox"] {
            margin-right: 8px;
        }
        .column-item label {
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }
        .column-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .status-container {
            margin-top: 10px;
            display: none;
        }
        .progress-container {
            margin-top: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            border: 1px solid #ddd;
        }
        .progress-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-status {
            font-size: 14px;
            color: #495057;
            margin-bottom: 5px;
        }
        .progress-details {
            font-size: 12px;
            color: #6c757d;
            max-height: 100px;
            overflow-y: auto;
            background-color: #f1f3f5;
            padding: 8px;
            border-radius: 4px;
            margin-top: 5px;
        }
        .btn-with-spinner {
            position: relative;
        }
        .btn-spinner {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            display: none;
        }
        .btn-with-spinner.loading .btn-spinner {
            display: block;
        }
        .btn-with-spinner.loading {
            padding-right: 40px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-time {
            color: #6c757d;
            font-size: 11px;
            margin-right: 5px;
        }
        .log-info {
            color: #0c5460;
        }
        .log-warning {
            color: #856404;
        }
        .log-error {
            color: #721c24;
        }
        .log-success {
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div class="form-group">
                <label for="district-select">Select District:</label>
                <select id="district-select">
                    <option value="0">Citywide (All Districts)</option>
                    <option value="1">District 1</option>
                    <option value="2">District 2</option>
                    <option value="3">District 3</option>
                    <option value="4">District 4</option>
                    <option value="5">District 5</option>
                    <option value="6">District 6</option>
                    <option value="7">District 7</option>
                    <option value="8">District 8</option>
                    <option value="9">District 9</option>
                    <option value="10">District 10</option>
                    <option value="11">District 11</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="metric-select">Select Metric:</label>
                <select id="metric-select">
                    <option value="all">All Metrics</option>
                    <option value="1">Loading metrics...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="period-type-select">Period Type:</label>
                <select id="period-type-select">
                    <option value="month">Monthly Analysis</option>
                    <option value="year">Annual Analysis</option>
                    <option value="week">Weekly Analysis</option>
                    <option value="both">Monthly & Annual Analysis</option>
                </select>
            </div>
            
            <div class="form-group">
                <button id="generate-metrics-btn" class="btn btn-secondary btn-with-spinner">
                    Generate Metrics
                    <span class="btn-spinner"></span>
                </button>
            </div>
        </div>
        
        <!-- Progress and status information moved below the controls -->
        <div id="generate-status" class="status-container"></div>
        <div id="generate-progress" class="progress-container" style="display: none;">
            <div class="progress-status">Initializing metric generation...</div>
            <div class="progress-bar">
                <div class="progress-bar-fill"></div>
            </div>
            <div class="progress-details" id="progress-log"></div>
        </div>
        
        <!-- Add column selection section -->
        <div id="column-selection" class="column-selection" style="display: none;">
            <h3>Select Columns for Enhanced Dashboard</h3>
            <div class="column-grid" id="column-grid">
                <!-- Columns will be populated here -->
            </div>
            <div class="column-actions">
                <button id="select-all-columns" class="btn btn-primary">Select All</button>
                <button id="deselect-all-columns" class="btn btn-primary">Deselect All</button>
                <button id="update-columns" class="btn btn-primary">Update Enhanced Queries</button>
            </div>
            <div id="column-update-status" style="margin-top: 10px; display: none;"></div>
        </div>
        
        <div class="output-windows">
            <div class="output-window">
                <h3>Dashboard Output</h3>
                <div id="dashboard-output" class="output-content">Select a metric to view dashboard output</div>
            </div>
            
            <div class="output-window">
                <h3>Annual Output</h3>
                <div id="annual-output" class="output-content">Select a metric to view annual output</div>
            </div>
            
            <div class="output-window">
                <h3>Monthly Output</h3>
                <div id="monthly-output" class="output-content">Select a metric to view monthly output</div>
            </div>
            
            <div class="output-window">
                <h3>Weekly Output</h3>
                <div id="weekly-output" class="output-content">Select a metric to view weekly output</div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const districtSelect = document.getElementById('district-select');
            const metricSelect = document.getElementById('metric-select');
            const dashboardOutput = document.getElementById('dashboard-output');
            const annualOutput = document.getElementById('annual-output');
            const monthlyOutput = document.getElementById('monthly-output');
            const weeklyOutput = document.getElementById('weekly-output');
            const generateMetricsBtn = document.getElementById('generate-metrics-btn');
            const generateStatus = document.getElementById('generate-status');
            const periodTypeSelect = document.getElementById('period-type-select');
            
            let metrics = [];
            
            // Function to load metrics data
            async function loadMetrics() {
                try {
                    const response = await fetch('/api/enhanced-queries');
                    if (!response.ok) {
                        throw new Error('Failed to load metrics data');
                    }
                    
                    const data = await response.json();
                    metrics = [];
                    
                    // Extract all metrics from the data structure
                    Object.entries(data).forEach(([category, categoryData]) => {
                        Object.entries(categoryData).forEach(([subcategory, subcategoryData]) => {
                            if (subcategoryData.queries) {
                                Object.entries(subcategoryData.queries).forEach(([metricName, metricData]) => {
                                    metrics.push({
                                        id: metricData.id,
                                        name: metricName,
                                        category: category,
                                        subcategory: subcategory,
                                        endpoint: metricData.endpoint
                                    });
                                });
                            }
                        });
                    });
                    
                    // Sort metrics by ID
                    metrics.sort((a, b) => a.id - b.id);
                    
                    // Populate metric select
                    metricSelect.innerHTML = `
                        <option value="all">All Metrics</option>
                        ${metrics.map(metric => 
                            `<option value="${metric.id}">${metric.id} - ${metric.name}</option>`
                        ).join('')}
                    `;
                    
                    // Load initial outputs
                    loadOutputs();
                } catch (error) {
                    console.error('Error loading metrics:', error);
                    metricSelect.innerHTML = '<option value="">Error loading metrics</option>';
                }
            }
            
            // Function to load output files
            async function loadOutputs() {
                const metricId = metricSelect.value;
                const districtId = districtSelect.value;
                
                if (!metricId) return;
                
                console.log(`Loading outputs for district ${districtId}, metric ${metricId}`);
                
                // Show loading state
                [dashboardOutput, annualOutput, monthlyOutput, weeklyOutput].forEach(output => {
                    output.innerHTML = '<div class="spinner"></div> Loading...';
                });
                
                try {
                    // Load dashboard output
                    const dashboardResponse = await fetch(`/output/dashboard/${districtId}/${metricId}.json`);
                    if (dashboardResponse.ok) {
                        const dashboardData = await dashboardResponse.json();
                        dashboardOutput.textContent = JSON.stringify(dashboardData, null, 2);
                    } else {
                        console.warn(`Dashboard output not found: /output/dashboard/${districtId}/${metricId}.json (${dashboardResponse.status})`);
                        dashboardOutput.textContent = 'No dashboard output available for this district/metric combination';
                    }
                    
                    // Load annual output
                    const annualResponse = await fetch(`/output/annual/${districtId}/${metricId}.md`);
                    if (annualResponse.ok) {
                        const annualText = await annualResponse.text();
                        annualOutput.innerHTML = marked.parse(annualText);
                        annualOutput.classList.add('markdown');
                    } else {
                        console.warn(`Annual output not found: /output/annual/${districtId}/${metricId}.md (${annualResponse.status})`);
                        annualOutput.textContent = 'No annual output available for this district/metric combination';
                    }
                    
                    // Load monthly output
                    const monthlyResponse = await fetch(`/output/monthly/${districtId}/${metricId}.md`);
                    if (monthlyResponse.ok) {
                        const monthlyText = await monthlyResponse.text();
                        monthlyOutput.innerHTML = marked.parse(monthlyText);
                        monthlyOutput.classList.add('markdown');
                    } else {
                        console.warn(`Monthly output not found: /output/monthly/${districtId}/${metricId}.md (${monthlyResponse.status})`);
                        monthlyOutput.textContent = 'No monthly output available for this district/metric combination';
                    }
                    
                    // Load weekly output
                    const weeklyResponse = await fetch(`/output/weekly/${districtId}/${metricId}.md`);
                    if (weeklyResponse.ok) {
                        const weeklyText = await weeklyResponse.text();
                        weeklyOutput.innerHTML = marked.parse(weeklyText);
                        weeklyOutput.classList.add('markdown');
                    } else {
                        console.warn(`Weekly output not found: /output/weekly/${districtId}/${metricId}.md (${weeklyResponse.status})`);
                        weeklyOutput.textContent = 'No weekly output available for this district/metric combination';
                    }
                } catch (error) {
                    console.error('Error loading outputs:', error);
                    [dashboardOutput, annualOutput, monthlyOutput, weeklyOutput].forEach(output => {
                        output.textContent = `Error loading output: ${error.message}`;
                    });
                }
            }
            
            // Event listeners
            districtSelect.addEventListener('change', loadOutputs);
            metricSelect.addEventListener('change', loadOutputs);
            
            // Generate metrics functionality
            generateMetricsBtn.addEventListener('click', async () => {
                const periodType = periodTypeSelect.value;
                const metricId = metricSelect.value;
                const districtId = districtSelect.value;
                const progressContainer = document.getElementById('generate-progress');
                const progressBar = progressContainer.querySelector('.progress-bar-fill');
                const progressStatus = progressContainer.querySelector('.progress-status');
                const progressLog = document.getElementById('progress-log');
                
                if (!metricId) {
                    generateStatus.style.display = 'block';
                    generateStatus.innerHTML = `
                        <div style="color: #dc3545;">
                            <h4>❌ Error</h4>
                            <p>Please select a metric first</p>
                        </div>
                    `;
                    return;
                }
                
                try {
                    // Reset and show progress UI
                    generateMetricsBtn.classList.add('loading');
                    generateMetricsBtn.disabled = true;
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '0%';
                    progressStatus.textContent = 'Initializing metric generation...';
                    progressLog.innerHTML = '';
                    
                    // Add initial log entry
                    addLogEntry('Starting metric generation process...', 'info');
                    
                    // Handle "All Metrics" selection
                    if (metricId === 'all') {
                        // For 'both' period type, we need to make two separate calls for each metric
                        if (periodType === 'both') {
                            // First run monthly analysis for all metrics
                            progressStatus.textContent = 'Running monthly analysis for all metrics...';
                            progressBar.style.width = '25%';
                            addLogEntry('Starting monthly analysis for all metrics...', 'info');
                            
                            // Run monthly analysis for each metric
                            for (let i = 0; i < metrics.length; i++) {
                                const metric = metrics[i];
                                const progress = ((i + 1) / metrics.length) * 25;
                                progressBar.style.width = `${progress}%`;
                                progressStatus.textContent = `Running monthly analysis for metric ${metric.id} (${i + 1}/${metrics.length})...`;
                                addLogEntry(`Processing monthly analysis for metric ${metric.id} - ${metric.name}...`, 'info');
                                
                                const monthlyResponse = await fetch(`/backend/run_specific_metric?metric_id=${metric.id}&district_id=${districtId}&period_type=month`, {
                                    method: 'GET',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });
                                
                                const monthlyData = await monthlyResponse.json();
                                if (monthlyData.status !== 'success') {
                                    addLogEntry(`Warning: Monthly analysis failed for metric ${metric.id}: ${monthlyData.message}`, 'warning');
                                } else {
                                    addLogEntry(`Completed monthly analysis for metric ${metric.id}`, 'success');
                                }
                            }
                            
                            progressBar.style.width = '50%';
                            addLogEntry('Monthly analysis completed for all metrics', 'success');
                            
                            // Then run annual analysis for all metrics
                            progressStatus.textContent = 'Running annual analysis for all metrics...';
                            addLogEntry('Starting annual analysis for all metrics...', 'info');
                            
                            // Run annual analysis for each metric
                            for (let i = 0; i < metrics.length; i++) {
                                const metric = metrics[i];
                                const progress = 50 + ((i + 1) / metrics.length) * 50;
                                progressBar.style.width = `${progress}%`;
                                progressStatus.textContent = `Running annual analysis for metric ${metric.id} (${i + 1}/${metrics.length})...`;
                                addLogEntry(`Processing annual analysis for metric ${metric.id} - ${metric.name}...`, 'info');
                                
                                const annualResponse = await fetch(`/backend/run_specific_metric?metric_id=${metric.id}&district_id=${districtId}&period_type=year`, {
                                    method: 'GET',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });
                                
                                const annualData = await annualResponse.json();
                                if (annualData.status !== 'success') {
                                    addLogEntry(`Warning: Annual analysis failed for metric ${metric.id}: ${annualData.message}`, 'warning');
                                } else {
                                    addLogEntry(`Completed annual analysis for metric ${metric.id}`, 'success');
                                }
                            }
                            
                            progressBar.style.width = '100%';
                            progressStatus.textContent = 'Monthly and annual analysis completed for all metrics';
                            addLogEntry('All metric generation completed', 'success');
                            
                            generateStatus.innerHTML = `
                                <div style="color: #28a745;">
                                    <h4>✅ Generation Complete</h4>
                                    <p>Monthly and annual analysis completed for all metrics</p>
                                </div>
                            `;
                        } else if (periodType === 'week') {
                            // Weekly analysis - calls a different endpoint
                            progressStatus.textContent = 'Running weekly analysis for all metrics...';
                            progressBar.style.width = '50%';
                            addLogEntry('Starting weekly analysis for all metrics...', 'info');
                            
                            const response = await fetch(`/api/weekly-analysis?include_districts=true`, {
                                method: 'GET'
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                progressBar.style.width = '100%';
                                progressStatus.textContent = 'Weekly analysis completed successfully for all default metrics';
                                addLogEntry('Weekly analysis completed successfully', 'success');
                                
                                generateStatus.innerHTML = `
                                    <div style="color: #28a745;">
                                        <h4>✅ Weekly Analysis Complete</h4>
                                        <p>Weekly analysis completed successfully for all default metrics</p>
                                        <p><a href="/weekly-report" target="_blank">View Weekly Report</a></p>
                                    </div>
                                `;
                            } else {
                                throw new Error(data.error || 'Unknown error');
                            }
                        } else {
                            // Single period type analysis for all metrics
                            progressStatus.textContent = `Running ${periodType} analysis for all metrics...`;
                            addLogEntry(`Starting ${periodType} analysis for all metrics...`, 'info');
                            
                            // Run analysis for each metric
                            for (let i = 0; i < metrics.length; i++) {
                                const metric = metrics[i];
                                const progress = ((i + 1) / metrics.length) * 100;
                                progressBar.style.width = `${progress}%`;
                                progressStatus.textContent = `Running ${periodType} analysis for metric ${metric.id} (${i + 1}/${metrics.length})...`;
                                addLogEntry(`Processing ${periodType} analysis for metric ${metric.id} - ${metric.name}...`, 'info');
                                
                                const response = await fetch(`/backend/run_specific_metric?metric_id=${metric.id}&district_id=${districtId}&period_type=${periodType}`, {
                                    method: 'GET',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });
                                
                                const data = await response.json();
                                if (data.status !== 'success') {
                                    addLogEntry(`Warning: ${periodType} analysis failed for metric ${metric.id}: ${data.message}`, 'warning');
                                } else {
                                    addLogEntry(`Completed ${periodType} analysis for metric ${metric.id}`, 'success');
                                }
                            }
                            
                            progressBar.style.width = '100%';
                            progressStatus.textContent = `${periodType} analysis completed for all metrics`;
                            addLogEntry(`All ${periodType} analysis completed`, 'success');
                            
                            generateStatus.innerHTML = `
                                <div style="color: #28a745;">
                                    <h4>✅ Generation Complete</h4>
                                    <p>${periodType} analysis completed for all metrics</p>
                                </div>
                            `;
                        }
                    } else {
                        // Handle single metric selection
                        // For 'both' period type, we need to make two separate calls
                        if (periodType === 'both') {
                            // First run monthly analysis
                            progressStatus.textContent = 'Running monthly analysis...';
                            progressBar.style.width = '25%';
                            addLogEntry(`Starting monthly analysis for metric ${metricId} in district ${districtId}...`, 'info');
                            
                            const monthlyResponse = await fetch(`/backend/run_specific_metric?metric_id=${metricId}&district_id=${districtId}&period_type=month`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            const monthlyData = await monthlyResponse.json();
                            if (monthlyData.status !== 'success') {
                                throw new Error(`Monthly analysis failed: ${monthlyData.message}`);
                            }
                            
                            progressBar.style.width = '50%';
                            addLogEntry('Monthly analysis completed successfully', 'success');
                            
                            // Then run annual analysis
                            progressStatus.textContent = 'Running annual analysis...';
                            addLogEntry(`Starting annual analysis for metric ${metricId} in district ${districtId}...`, 'info');
                            
                            const annualResponse = await fetch(`/backend/run_specific_metric?metric_id=${metricId}&district_id=${districtId}&period_type=year`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            const annualData = await annualResponse.json();
                            if (annualData.status !== 'success') {
                                throw new Error(`Annual analysis failed: ${annualData.message}`);
                            }
                            
                            progressBar.style.width = '100%';
                            progressStatus.textContent = 'Monthly and annual analysis completed successfully';
                            addLogEntry('Annual analysis completed successfully', 'success');
                            
                            generateStatus.innerHTML = `
                                <div style="color: #28a745;">
                                    <h4>✅ Generation Complete</h4>
                                    <p>Monthly and annual analysis completed successfully</p>
                                </div>
                            `;
                        } else if (periodType === 'week') {
                            // Weekly analysis - calls a different endpoint
                            progressStatus.textContent = 'Running weekly analysis...';
                            progressBar.style.width = '50%';
                            addLogEntry(`Starting weekly analysis for metric ${metricId} in district ${districtId}...`, 'info');
                            
                            const response = await fetch(`/api/weekly-analysis?metrics=${metricId}&include_districts=true`, {
                                method: 'GET'
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                progressBar.style.width = '100%';
                                progressStatus.textContent = 'Weekly analysis completed successfully';
                                addLogEntry('Weekly analysis completed successfully', 'success');
                                
                                generateStatus.innerHTML = `
                                    <div style="color: #28a745;">
                                        <h4>✅ Weekly Analysis Complete</h4>
                                        <p>Weekly analysis completed successfully</p>
                                        <p><a href="/weekly-report" target="_blank">View Weekly Report</a></p>
                                    </div>
                                `;
                            } else {
                                throw new Error(data.error || 'Unknown error');
                            }
                        } else {
                            // Single period type analysis
                            progressStatus.textContent = `Running ${periodType} analysis...`;
                            progressBar.style.width = '50%';
                            addLogEntry(`Starting ${periodType} analysis for metric ${metricId} in district ${districtId}...`, 'info');
                            
                            const response = await fetch(`/backend/run_specific_metric?metric_id=${metricId}&district_id=${districtId}&period_type=${periodType}`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            const data = await response.json();
                            
                            if (data.status === 'success') {
                                progressBar.style.width = '100%';
                                progressStatus.textContent = `${periodType} analysis completed successfully`;
                                addLogEntry(`${periodType} analysis completed successfully`, 'success');
                                
                                generateStatus.innerHTML = `
                                    <div style="color: #28a745;">
                                        <h4>✅ Generation Complete</h4>
                                        <p>${data.message}</p>
                                    </div>
                                `;
                            } else {
                                throw new Error(data.message);
                            }
                        }
                    }
                    
                    // Reload outputs after successful generation
                    await loadOutputs();
                } catch (error) {
                    console.error('Error generating metrics:', error);
                    progressBar.style.width = '100%';
                    progressBar.style.backgroundColor = '#dc3545';
                    progressStatus.textContent = `Error: ${error.message}`;
                    addLogEntry(`Error: ${error.message}`, 'error');
                    
                    generateStatus.innerHTML = `
                        <div style="color: #dc3545;">
                            <h4>❌ Error</h4>
                            <p>An error occurred while generating metrics: ${error.message}</p>
                        </div>
                    `;
                } finally {
                    generateMetricsBtn.classList.remove('loading');
                    generateMetricsBtn.disabled = false;
                }
            });
            
            // Function to add a log entry with timestamp
            function addLogEntry(message, type = 'info') {
                const progressLog = document.getElementById('progress-log');
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.innerHTML = `<span class="log-time">[${timeString}]</span> ${message}`;
                
                progressLog.appendChild(logEntry);
                progressLog.scrollTop = progressLog.scrollHeight;
            }
            
            // Function to load columns for a metric
            async function loadColumns(metricId) {
                const metric = metrics.find(m => m.id === parseInt(metricId));
                if (!metric) return;

                const columnSelection = document.getElementById('column-selection');
                const columnGrid = document.getElementById('column-grid');
                const columnUpdateStatus = document.getElementById('column-update-status');

                try {
                    // Show loading state
                    columnSelection.style.display = 'block';
                    columnGrid.innerHTML = '<div class="spinner"></div> Loading columns...';
                    
                    // Fetch columns from the endpoint
                    const response = await fetch(`/backend/get-endpoint-columns/${encodeURIComponent(metric.endpoint)}`);
                    if (!response.ok) {
                        throw new Error('Failed to load columns');
                    }
                    
                    const data = await response.json();
                    
                    // Fetch currently selected columns - UPDATED to include metric_id
                    const selectedResponse = await fetch(`/backend/get-selected-columns/${encodeURIComponent(metric.endpoint)}?metric_id=${metricId}`);
                    const selectedData = await selectedResponse.json();
                    const selectedColumns = new Set(selectedData.columns || []);
                    
                    // Populate column grid
                    columnGrid.innerHTML = data.columns.map(column => `
                        <div class="column-item">
                            <input type="checkbox" id="col-${column}" value="${column}" 
                                ${selectedColumns.has(column) ? 'checked' : ''}>
                            <label for="col-${column}">${column}</label>
                        </div>
                    `).join('');
                    
                    // Add event listeners for select all/deselect all
                    document.getElementById('select-all-columns').onclick = () => {
                        columnGrid.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                            checkbox.checked = true;
                        });
                    };
                    
                    document.getElementById('deselect-all-columns').onclick = () => {
                        columnGrid.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                            checkbox.checked = false;
                        });
                    };
                    
                    // Add event listener for update button
                    document.getElementById('update-columns').onclick = async () => {
                        const selectedColumns = Array.from(columnGrid.querySelectorAll('input[type="checkbox"]:checked'))
                            .map(checkbox => checkbox.value);
                        
                        try {
                            columnUpdateStatus.style.display = 'block';
                            columnUpdateStatus.innerHTML = '<div class="spinner"></div> Updating columns...';
                            
                            const updateResponse = await fetch('/backend/update-selected-columns', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    endpoint: metric.endpoint,
                                    metric_id: metric.id,
                                    columns: selectedColumns
                                })
                            });
                            
                            const updateData = await updateResponse.json();
                            
                            if (updateData.status === 'success') {
                                columnUpdateStatus.innerHTML = `
                                    <div style="color: #28a745;">
                                        <h4>✅ Update Complete</h4>
                                        <p>${updateData.message}</p>
                                    </div>
                                `;
                                // Save the current selection before reloading metrics
                                const currentMetricId = metricSelect.value;
                                
                                // Reload metrics to refresh the enhanced queries
                                await loadMetrics();
                                
                                // Restore the previous selection
                                if (currentMetricId) {
                                    metricSelect.value = currentMetricId;
                                    // Trigger change event to update relevant UI
                                    metricSelect.dispatchEvent(new Event('change'));
                                }
                            } else {
                                throw new Error(updateData.message);
                            }
                        } catch (error) {
                            console.error('Error updating columns:', error);
                            columnUpdateStatus.innerHTML = `
                                <div style="color: #dc3545;">
                                    <h4>❌ Error</h4>
                                    <p>An error occurred while updating columns: ${error.message}</p>
                                </div>
                            `;
                        }
                    };
                } catch (error) {
                    console.error('Error loading columns:', error);
                    columnGrid.innerHTML = `
                        <div style="color: #dc3545;">
                            <h4>❌ Error</h4>
                            <p>Failed to load columns: ${error.message}</p>
                        </div>
                    `;
                }
            }

            // Add event listener for metric selection
            metricSelect.addEventListener('change', () => {
                const metricId = metricSelect.value;
                if (metricId) {
                    loadColumns(metricId);
                } else {
                    document.getElementById('column-selection').style.display = 'none';
                }
            });
            
            // Load metrics when page loads
            loadMetrics();
        });
    </script>
</body>
</html> 